<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Test Map</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <style>
    #map {
      height: 500px;
    }
  </style>

</head>

<body>

  <div id="mapContainer">

    <br>
    <div id="map"></div>
    <!--map-->
    <div id="textDirections"></div>

    <div id="floating-panel">
      <b>Mode of Travel: </b>
      <select id="mode">
        <option value="DRIVING">Driving</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Bicycling</option>
        <option value="TRANSIT">Transit</option>
      </select>
    </div>



  </div>
  <!--map container-->

  <script>
    console.log("Correct Map");

    var map;
    var pos;
    var infowindow;
    var infoWindowUser;
    var interval;
    var GeoMarker;
    var austin;

    function initMap() {

      $("#mapText").html("Go and get some!");

      var austin = {
        lat: 30.2672,
        lng: -97.7431
      };

      map = new google.maps.Map(document.getElementById('map'), {
        center: austin,
        zoom: 13,
        mapTypeId: "roadmap"
      });

      infowindow = new google.maps.InfoWindow();
      // infoWindowUser = new google.maps.InfoWindow();

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };

          var marker = new google.maps.Marker({
            map: map,
            icon: 'assets/Images/blueDot.png',
            position: pos
          });

          map.setCenter(pos);

          // GeoMarker = new GeolocationMarker();
          // GeoMarker.setCircleOptions({fillColor: '#808080'});
          //
          // GeoMarker.setMap(map);

          // infoWindowUser.setPosition(pos);
          // infoWindowUser.setContent('Location found.');
          // infoWindowUser.open(map);
          // map.setCenter(pos);

          search();

        }, function() {
          handleLocationError(true, infoWindowUser, map.getCenter());
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindowUser, map.getCenter());
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindowUser.setPosition(pos);
        infoWindowUser.setContent(browserHasGeolocation ?
          'Error: The Geolocation service failed.' :
          'Error: Your browser doesn\'t support geolocation.');
        infoWindowUser.open(map);
        console.log("I just blocked this");
      }
    }

    function search() {

      var request = {
        location: pos,
        radius: '5000',
        type: ["cafe"]
      };

      service = new google.maps.places.PlacesService(map);
      service.nearbySearch(request, callback);
    }

    function callback(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        for (var i = 0; i < results.length; i++) {
          var place = results[i];
          createMarker(results[i]);
        }
      }
    }


    // Function that creates the Google Maps Marker
    var id = 0;
    var destination;
    var placeLoc;
    var isOpen;



    function createMarker(place) {
      placeLoc = place.geometry.location;
      var marker = new google.maps.Marker({
        map: map,
        // icon: 'coffee-icon-png-24.png',
        animation: google.maps.Animation.DROP,
        position: place.geometry.location
      });

      // console.log("item: " + place.geometry.location);
      // console.log(place);

      google.maps.event.addListener(infowindow, 'domready', function() {
        var iwOuter = $('.gm-style-iw');
        var iwBackground = iwOuter.prev();
        // iwBackground.children(':nth-child(2)').css({'display': 'none'});
        // iwBackground.children(':nth-child(4)').css({'display': 'none'});
        // iwOuter.parent().parent().css({left: '115px'});
        // iwBackground.children(':nth-child(1)').attr('style', function(i,s){ return s + 'left: 76px !important;'});
        // iwBackground.children(':nth-child(3)').attr('style', function(i,s){ return s + 'left: 76px !important;'});
        // iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});

        var iwCloseBtn = iwOuter.next();
        iwCloseBtn.css({
          opacity: '1', // by default the close button has an opacity of 0.7
          right: '8px',
          top: '15px', // button repositioning
          border: '7px solid #48b5e9', // increasing button border and new color
          'border-radius': '13px', // circular effect
          'box-shadow': '0 0 5px #3990B9' // 3D effect to highlight the button
        });

        iwCloseBtn.mouseout(function() {
          $(this).css({
            opacity: '1'
          });
        });
      });



      google.maps.event.addListener(marker, 'click', function() {
        isOpen = place.opening_hours.open_now;

        if (isOpen !== true) {
          isOpen = "Closed";
        } else {
          isOpen = "Open";
        }

        // console.log(isOpen);
        var contentString = '<div id="iw-container">' +
          '<div class="iw-title">' + place.name + '</div>' +
          '<div class="iw-content">' +
          '<div id="open">' + isOpen + '</div><br>' +
          '<div id="rating">' + "Rating: " + place.rating + '</div>' +
          '<img id="image" src="' + place.photos[0].getUrl({
            'maxWidth': 100,
            'maxHeight': 100
          }) + '"><br>' +
          '<button id="directions" onclick="getDirections()">' + "Directions" + '</button>' +
          '</div>' +
          '</div>' +
          '</div>';
        destination = place.geometry.location;
        infowindow.setContent(contentString);
        infowindow.open(map, this);
      });
    }

    var travelMode = 'DRIVING';

    function getDirections() {
      $("#textDirections").show();
      var directionsService = new google.maps.DirectionsService;
      var directionsDisplay = new google.maps.DirectionsRenderer;
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: {
          lat: 30.2672,
          lng: -97.7431
        }
      });
      $("#floating-panel").show();
      $("#textDirections").css("width", "40%");
      $("#map").css("width", "60%");
      directionsDisplay.setMap(map);
      directionsDisplay.setPanel(document.getElementById('textDirections'));
      var control = document.getElementById("floating-panel");
      control.style.display = "block";
      map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);
      document.getElementById('mode').addEventListener('change', function() {
        travelMode = $('#mode').val();
        calculateAndDisplayRoute(directionsService, directionsDisplay);
      });

      calculateAndDisplayRoute(directionsService, directionsDisplay);
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      directionsService.route({
        origin: pos,
        destination: destination,
        travelMode: travelMode,
        // travelMode: 'DRIVING',
        provideRouteAlternatives: true
      }, function(response, status) {
        if (status === 'OK') {
          directionsDisplay.setDirections(response);
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });
    }


  </script>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYSt64gQeJuUFHPhjWPTfiJmGjUOaBm6Y&libraries=places&callback=initMap" async defer></script>

</body>

</html>
